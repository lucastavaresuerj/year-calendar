version: 0.2

env:
  variables:
    GRAPHQL_FOLDER_PATH: "cfn-templates/graphQL"

    S3_BUCKET_NAME: ""
    STACK_NAME: ""

phases:
  install:
    runtime-versions:
      nodejs: 12
    commands:
      - npm i -g graphql-schema-utilities
      - npm i -g fx

  pre_build:
    commands:
      - echo "merging graphql files"
      - |
        graphql-schema-utilities \
        -s "./${GRAPHQL_FOLDER_PATH}/schema-definition/**/*.graphql" \
        -o "./${GRAPHQL_FOLDER_PATH}/schema-${CODEBUILD_BUILD_NUMBER}.graphql"
      - rm ./${GRAPHQL_FOLDER_PATH}/schema-definition -r
      # Will compare new schema builded with the schema at s3
      - echo "comparing with the last schema from s3"
      - |
        aws s3 sync \
          s3://${S3_BUCKET_NAME}/${GRAPHQL_FOLDER_PATH}/ \
          ./${GRAPHQL_FOLDER_PATH}/ \
          --exclude "*" \
          --include "schema-*.graphql"
      - diff ./${GRAPHQL_FOLDER_PATH}/schema-*.graphql
      # "$?" variable that store the exit code of the last command
      - echo "changing parameter GraphQLSchemaFileName"
      - |
        [ $? -qt 0 ] && { \
          echo "need to update" \
          diff schema-*.graphql \
          cat cfn-templates/parameters.json | \
            fx ".map($(cat cfn-templates/mapParams.js))" \
            > cfn-templates/parameters.json \
        } || { \
          echo "GraphQL schemas are equals, there is no need to update" \
          rm ./${GRAPHQL_FOLDER_PATH}/schema-definition \
        }

  build:
    commands:
      - aws s3 sync ./cfn-templates s3://${S3_BUCKET_NAME}/cfn-templates --delete
      - |
        aws cloudformation update-stack \
        --stack-name ${STACK_NAME} \
        --template-body file://cfn-templates/main-template.yaml \
        --parameters file://cfn-templates/parameters.json \
        --capabilities CAPABILITY_NAMED_IAM CAPABILITY_AUTO_EXPAND
