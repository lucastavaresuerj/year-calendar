version: 0.2

env:
  variables:
    GRAPHQL_FOLDER_PATH: "cfn-templates/graphQL"

    S3_BUCKET_NAME: ""
    STACK_NAME: ""

phases:
  install:
    runtime-versions:
      nodejs: 12
    commands:
      - npm i -g graphql-schema-utilities
      - npm i -g fx

  pre_build:
    on-failure: ABORT
    commands:
      - echo "merging graphql files"
      - |
        graphql-schema-utilities \
        -s "./${GRAPHQL_FOLDER_PATH}/schema-definition/**/*.graphql" \
        -o "./${GRAPHQL_FOLDER_PATH}/schema.graphql-${CODEBUILD_BUILD_NUMBER}"
      - rm ./${GRAPHQL_FOLDER_PATH}/schema-definition -r
      - echo "changing parameter GraphQLSchemaFileName"
      - |
        cat cfn-templates/parameters.json | \
        fx ".map($(cat cfn-templates/mapParams.js))" \
        > cfn-templates/parameters.json

  build:
    commands:
      - aws s3 sync ./cfn-templates s3://${S3_BUCKET_NAME}/cfn-templates --delete
      - |
        aws cloudformation update-stack \
        --stack-name ${STACK_NAME} \
        --template-body file://cfn-templates/main-template.yaml \
        --parameters file://cfn-templates/parameters.json \
        --capabilities CAPABILITY_NAMED_IAM CAPABILITY_AUTO_EXPAND
