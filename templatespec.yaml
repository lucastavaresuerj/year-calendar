version: 0.2

env:
  variables:
    S3_BUCKET_NAME: ""
    STACK_NAME: ""

phases:
  install:
    runtime-versions:
      nodejs: 12
    commands:
      - npm i -g graphql-schema-utilities

  pre_build:
    on-failure: ABORT
    commands:
      - echo "merging graphql files"
      - |
        graphql-schema-utilities \
        -s "./cfn-templates/graphQL/schema-definition/**/*.graphql" \
        -o "./cfn-templates/graphQL/schema.graphql"
      - rm ./cfn-templates/graphQL/schema-definition -r
  build:
    commands:
      - aws s3 sync ./cfn-templates s3://${S3_BUCKET_NAME}/cfn-templates --delete
      - |
        aws cloudformation update-stack --stack-name ${STACK_NAME} \
        --template-body file://cfn-templates/main-template.yaml \
        --parameters file://cfn-templates/parameters.json \
        --capabilities CAPABILITY_NAMED_IAM CAPABILITY_AUTO_EXPAND

artifacts:
  files:
    - "./cfn-templates/graphQL/schema.graphql"
  name: "graphql schema - $(date +%Y-%m-%d)"
